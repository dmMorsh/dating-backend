# dating-backend - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- –û–ø–∏—Å–∞–Ω–∏–µ
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –ú–∏–≥—Ä–∞—Ü–∏–∏
- API (–∫—Ä–∞—Ç–∫–æ)
- WebSocket
- –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
- –û—Ç–ª–∞–¥–∫–∞ –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
- –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –û–ø–∏—Å–∞–Ω–∏–µ

`dating-backend` - REST + WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–∞ Go.

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

- —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (access/refresh —Ç–æ–∫–µ–Ω—ã)
- —Å–≤–∞–π–ø—ã (like/dislike)
- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç—á–µ–π (—Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ –ø—Ä–∏ –≤–∑–∞–∏–º–Ω—ã—Ö –ª–∞–π–∫–∞—Ö)
- –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ WebSocket

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Go 1.20+
- Git
- SQLite –≤—Å—Ç—Ä–æ–µ–Ω–∞ (—á–µ—Ä–µ–∑ modernc.org/sqlite), —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –°–£–ë–î –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

Windows / macOS / Linux

```bash
git clone https://github.com/dmMorsh/dating-backend.git
cd dating-backend/src
go run ./cmd
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç `:8088` (—Å–º. `cmd/main.go`).

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü—Ä–æ–µ–∫—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ - –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∫–æ–¥–µ.

| –ü–∞—Ä–∞–º–µ—Ç—Ä      | –û–ø–∏—Å–∞–Ω–∏–µ                        | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| ------------- | ------------------------------- | --------------------- |
| PORT          | –ü–æ—Ä—Ç HTTP-—Å–µ—Ä–≤–µ—Ä–∞               | 8088                  |
| DATABASE_PATH | –ü—É—Ç—å –∫ SQLite —Ñ–∞–π–ª—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö | ./dating.db           |

–ï—Å–ª–∏ —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –æ–Ω —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.

> üí° –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`PORT`, `DATABASE_PATH`) –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ –∏ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

## –ú–∏–≥—Ä–∞—Ü–∏–∏

–ú–∏–≥—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ `internal/data-access/migrations.go`.

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å—Ö–µ–º–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø–æ–ª–µ–º `birthday` —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–∏–ø SQLiteDate –≤–º–µ—Å—Ç–æ time.Time –∏–ª–∏ JSONDate, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É —á–µ—Ä–µ–∑ julianday.
–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ PostgreSQL –ø—Ä–∏–¥–µ—Ç—Å—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö.

## API (–∫—Ä–∞—Ç–∫–æ)

–û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ - –≤ `internal/handlers`):

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

- POST /register - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- POST /login - –ø–æ–ª—É—á–µ–Ω–∏–µ access + refresh —Ç–æ–∫–µ–Ω–æ–≤
- POST /refresh - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞
- POST /logout - —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏

### –ü—Ä–æ—Ñ–∏–ª—å –∏ —Å–≤–∞–π–ø—ã

- GET /me - –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
- PUT /me - –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
- POST /swipe - —Å–≤–∞–π–ø (like/dislike)
- DELETE /clear/my/swipes - –æ—á–∏—Å—Ç–∏—Ç—å —Å–≤–æ–∏ —Å–≤–∞–π–ø—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

### –°–æ–æ–±—â–µ–Ω–∏—è –∏ —á–∞—Ç—ã

- POST /messages/send - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- GET /chat/messages/{chatId} - –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ (limit, before_id, after_id)
- POST /chat/read - –æ—Ç–º–µ—Ç–∏—Ç—å —á–∞—Ç –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π (body: chat_id, receiver_id)
- POST /messages/read - –æ—Ç–º–µ—Ç–∏—Ç—å –Ω–∞–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (body: chat_id, receiver_id, message_ids)

## WebSocket

### –ú–µ—Ö–∞–Ω–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

1. –ö–ª–∏–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç POST `/ws/start` (–∑–∞—â–∏—â—ë–Ω–Ω—ã–π endpoint, —Ç—Ä–µ–±—É–µ—Ç access token).
2. –°–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π session token –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON: `{ "session_token": "<token>" }`.
3. –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ GET `/ws/chat?session=<token>` (ws:// –∏–ª–∏ wss://) –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç WebSocket upgrade.
4. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ—Ç `Upgrade` –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ `internal/realtime/hub.go`.

–ö–ª—é—á–µ–≤—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è –ø–æ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

- Session tokens —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –≤ `map[string]int64` –∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ ~30s. –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–æ—Å—Ç—É–ø –∫ –Ω–∏–º –∑–∞—â–∏—â—ë–Ω —á–µ—Ä–µ–∑ mutex –≤ `internal/handlers/ws.go`, —á—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –≥–æ–Ω–∫–∏ –≤ –æ–¥–Ω–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏, –Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis —Å TTL.
- `Hub` —Ö—Ä–∞–Ω–∏—Ç –ø–æ –æ–¥–Ω–æ–º—É –∞–∫—Ç–∏–≤–Ω–æ–º—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Å—Ç–∞—Ä—É—é).
- –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—â–∏–π ping-loop StartPingLoop(), –∫–æ—Ç–æ—Ä—ã–π —É–¥–∞–ª—è–µ—Ç –Ω–µ–æ—Ç–≤–µ—á–∞—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å Redis(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è Redis –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `REDIS_ADDR` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `localhost:6379`) –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞ - `cmd/main.go` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω–∏—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π in-memory store –Ω–∞ Redis-backed —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é.

```bash
$env:REDIS_ADDR = 'localhost:6379'
go run ./cmd
```

### –ü—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–æ–±—â–µ–Ω–∏–π

–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–¥—ë—Ç —á–µ—Ä–µ–∑ HTTP POST /messages/send, —Ö–µ–Ω–¥–ª–µ—Ä –∫–æ—Ç–æ—Ä–æ–≥–æ –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç WebSocket:

–ö–ª–∏–µ–Ω—Ç ‚Üí –°–µ—Ä–≤–µ—Ä ‚Üí –∑–∞–ø–∏—Å—å –≤ –±–¥ ‚Üí –ü–æ–ª—É—á–∞—Ç–µ–ª—å (WS, –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω) - –ø—Ä–∏–º–µ—Ä JSON:

```json
{
  "type": "message",
  "id": 1001,
  "chat_id": 42,
  "user_id": 5, //id –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  "content": "–ü—Ä–∏–≤–µ—Ç!"
}
```

ChatWebSocketHandler(internal/handlers/ws.go/) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è "typing" –∏ "delivered".

–ü—Ä–∏–º–µ—Ä—ã JSON-—Å–æ–æ–±—â–µ–Ω–∏–π:

```json
{
  "type": "typing",
  "chat_id": 42,
  "user_id": 5
}
```

```json
{
  "type": "delivered",
  "chat_id": 42,
  "user_id": 5,
  "message_id": 1001
}
```

–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ HTTP endpoints (`POST /chat/read`, `POST /messages/read`), —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ WebSocket.
–ü—Ä–∏–º–µ—Ä—ã JSON-—Å–æ–æ–±—â–µ–Ω–∏–π:

```json
{
  "type": "read_chat",
  "chat_id": 42,
  "user_id": 5
}
```

```json
{
  "type": "read_messages",
  "chat_id": 42,
  "user_id": 5,
  "message_ids": [101, 102, 106]
}
```

## –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

- SQLite –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º –∑–∞–ø–∏—Å—è–º - –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ PostgreSQL.
- WebSocket hub (`internal/realtime/hub.go`) —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å. –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
  - —Ö—Ä–∞–Ω–∏—Ç—å session tokens –≤ Redis
  - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω—é—é –æ—á–µ—Ä–µ–¥—å/pubsub (Redis, NATS)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

```
cmd/
  main.go                 # –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
internal/
  server/routes.go        # –º–∞—Ä—à—Ä—É—Ç—ã
  handlers/               # HTTP-—Ö—ç–Ω–¥–ª–µ—Ä—ã
  middleware/             # auth, cors, logging
  data-access/            # SQL –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  models/                 # —Å—É—â–Ω–æ—Å—Ç–∏ (User, Message –∏ —Ç.–ø.)
  realtime/hub.go         # WebSocket hub
  utils/                  # –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
```

## –û—Ç–ª–∞–¥–∫–∞ –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

| –û—à–∏–±–∫–∞                           | –ü—Ä–∏—á–∏–Ω–∞ / –†–µ—à–µ–Ω–∏–µ                                                  |
| -------------------------------- | ------------------------------------------------------------------ |
| Invalid username                 | –ß–∞—Å—Ç–æ, –ø—Ä–æ–±–µ–ª –≤ –∫–æ–Ω—Ü–µ –∏–º–µ–Ω–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–≤–æ–¥.                       |
| Invalid or expired refresh token | refresh token –∏—Å—Ç—ë–∫ –∏–ª–∏ –∏–∑ —Å–µ—Å—Å–∏–∏ –¥—Ä—É–≥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞, –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è |

## –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

- –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ PostgreSQL –∏ –¥–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ —Å golang-migrate
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus, Sentry)
- –ù–∞–ø–∏—Å–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã WebSocket
- –î–æ–±–∞–≤–∏—Ç—å Dockerfile –∏ docker-compose
- –î–æ–±–∞–≤–∏—Ç—å `/healthz` endpoint
